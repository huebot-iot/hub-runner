# Lib services required in development and production env
# Services that cannot be updated by end user
version: "3.9"
services:
  redis:
    image: redis:6.2-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - huebot-net

  nginx:
    image: ghcr.io/huebot-iot/nginx:1.0.3
    restart: unless-stopped
    network_mode: "host"

  mqtt_broker:
    image: ghcr.io/huebot-iot/mqtt:1.2.1
    restart: unless-stopped
    volumes:
      - /usr/local/bin/mosquitto/conf.d:/mosquitto/config/conf.d
      - /usr/local/bin/mosquitto/config.json:/etc/mosquitto/huebot.config
      - /usr/local/bin/mosquitto/data:/mosquitto/data
      - /usr/local/bin/mosquitto/log:/mosquitto/log
    ports:
      - 18831:1883
    networks:
      - huebot-net

  api:
    image: ghcr.io/huebot-iot/hub-core-api:0.1.5
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - HUEBOT_API_KEY=$HUEBOT_API_KEY
      - HUEBOT_SECRET_KEY=$HUEBOT_SECRET_KEY
      - MQTT_USERNAME=$MQTT_USERNAME
      - MQTT_PASSWORD=$MQTT_PASSWORD
    volumes:
      - /usr/local/bin/huebot/db:/usr/db
    ports:
      - 3000:3000
    networks:
      - huebot-net

  native:
    image: ghcr.io/huebot-iot/hub-core-native:0.1.2
    privileged: true
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    volumes:
      - /etc/NetworkManager:/etc/NetworkManager
      - /var/run/dbus:/var/run/dbus
    ports:
      - 9000:9000
    networks:
      - huebot-net

  mqtt:
    image: ghcr.io/huebot-iot/hub-core-mqtt:0.1.0
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - MQTT_USERNAME=$MQTT_USERNAME
      - MQTT_PASSWORD=$MQTT_PASSWORD
    networks:
      - huebot-net

  ble:
    image: ghcr.io/huebot-iot/hub-ble:0.1.0
    restart: unless-stopped
    privileged: true
    network_mode: "host"
    environment:
      - HUEBOT_API_KEY=$HUEBOT_API_KEY
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO

networks:
  huebot-net:
    name: hubNetwork
    driver: bridge